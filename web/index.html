<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>EV Punjači – Srbija</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    header {
      padding: 10px;
      background: #4f46e5;
      color: white;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #map { height: calc(100vh - 50px); }
    input, button { padding: 6px; }
  </style>
</head>
<body>

<header>
  <strong>⚡ EV Punjači – Srbija</strong>
  <input id="town" value=" " />
  <button id="btn">Pretraži</button>
</header>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const API_ID = "s0jkchifme";
  const API_BASE = "http://localhost:4566/restapis/s0jkchifme/dev/_user_request_";

  const map = L.map("map").setView([44.0165, 21.0059], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap"
  }).addTo(map);

  const markers = L.featureGroup().addTo(map);

  async function loadChargers() {
    let town = document.getElementById("town").value.trim();

    // Normalizacija: "cacak" -> "Cacak", "  novi sad " -> "Novi Sad"
    town = town
        .toLowerCase()
        .split(" ")
        .filter(Boolean)
        .map(w => w[0].toUpperCase() + w.slice(1))
        .join(" ");
    markers.clearLayers();

    try {
      const townEnc = encodeURIComponent(town);
      const url = `${API_BASE}/chargers/${townEnc}`;
      console.log("Fetching:", url);

      const res = await fetch(url);
      if (!res.ok) {
        const text = await res.text();
        console.error("HTTP error", res.status, text);
        alert(`Greška: ${res.status}`);
        return;
      }

      const data = await res.json();
      console.log("Response:", data);

      const list = data.chargers || [];
      if (list.length === 0) {
        alert(`Nema punjača za grad: ${town}`);
        return;
      }

      list.forEach(c => {
        const lat = Number(c.latitude);
        const lon = Number(c.longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

        const m = L.marker([lat, lon]).addTo(markers);
        m.bindPopup(`
          <b>${c.title || "Punjač"}</b><br/>
          ${c.addressLine1 || ""}<br/>
          ${c.town || ""}
        `);
      });

      const bounds = markers.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds, { padding: [30, 30] });

    } catch (err) {
      console.error("Fetch failed:", err);
      alert("Fetch failed, vidi Console (F12).");
    }
  }

  document.getElementById("btn").addEventListener("click", loadChargers);

  
  
</script>

</body>
</html>