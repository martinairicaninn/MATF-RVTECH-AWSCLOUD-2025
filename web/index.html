<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>EV Punjači – Srbija</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    header {
      padding: 10px;
      background: #4f46e5;
      color: white;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #map { height: calc(100vh - 50px); }
    input, button { padding: 6px; }
  </style>
</head>
<body>

<header>
  <strong>⚡ EV Punjači – Srbija</strong>
  <input id="town" value="Beograd" />
  <button id="btn">Pretraži</button>
</header>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const API_ID = "e6tcwmsm2u";
  const STAGE = "dev";
  const API_BASE = `http://localhost:4566/restapis/${API_ID}/${STAGE}/_user_request_`;

  const map = L.map("map").setView([44.0165, 21.0059], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap"
  }).addTo(map);

  const markers = L.featureGroup().addTo(map);

  async function loadChargers() {
    let town = document.getElementById("town").value.trim();

    // Ako je prazno, nemoj da puca
    if (!town) {
      alert("Unesi grad (npr. Beograd).");
      return;
    }

    // Normalizacija (opciono): "  novi sad " -> "Novi Sad"
    town = town
      .toLowerCase()
      .split(" ")
      .filter(Boolean)
      .map(w => w[0].toUpperCase() + w.slice(1))
      .join(" ");

    markers.clearLayers();

    try {
      const townEnc = encodeURIComponent(town);
      const url = `${API_BASE}/chargers/${townEnc}`;
      console.log("Fetching:", url);

      const res = await fetch(url);
      if (!res.ok) {
        const text = await res.text();
        console.error("HTTP error", res.status, text);
        alert(`Greška: ${res.status}`);
        return;
      }

      const data = await res.json();
      console.log("Response:", data);

      const list = data.chargers || [];
      if (list.length === 0) {
        alert(`Nema punjača za grad: ${town}`);
        return;
      }

     list.forEach(c => {
     const lat = Number(c.latitude);
      const lon = Number(c.longitude);
  if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

  const title = c.name || c.title || "Punjač";
  const addr  = c.addressLine1 || c.address || "";
  const town2 = c.town || "";

  const m = L.marker([lat, lon]).addTo(markers);
  m.bindPopup(`
    <b>${title}</b><br/>
    ${addr}<br/>
    ${town2}
  `);
})

      const bounds = markers.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds, { padding: [30, 30] });

    } catch (err) {
      console.error("Fetch failed:", err);
      alert("Fetch failed, vidi Console (F12).");
    }
  }

  document.getElementById("btn").addEventListener("click", loadChargers);

  // (opciono) automatski učitaj na startu ako hoćeš:
  // document.getElementById("town").value = "Beograd";
  // loadChargers();
</script>


</body>
</html>